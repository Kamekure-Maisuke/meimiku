<!doctype html>
<html lang="ja">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Book Manager</title>
        <link rel="stylesheet" href="style.css" />
        <script defer src="app.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
    </head>
    <body x-cloak x-data="bookApp()" x-init="init()">
        <!-- Ë™çË®ºÁîªÈù¢ -->
        <div id="auth-screen" x-show="!loggedIn">
            <div class="auth-card">
                <h1>Book Manager</h1>
                <div class="tab-bar">
                    <button :class="{ active: tab === 'login' }" @click="tab = 'login'">„É≠„Ç∞„Ç§„É≥</button>
                    <button :class="{ active: tab === 'signup' }" @click="tab = 'signup'">„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó</button>
                </div>

                <form x-show="tab === 'login'" @submit.prevent="login()">
                    <div class="auth-error" x-show="loginError" x-text="loginError"></div>
                    <div class="form-group">
                        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" x-model="loginForm.email" required />
                    </div>
                    <div class="form-group">
                        <label>„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" x-model="loginForm.password" required />
                    </div>
                    <button type="submit" class="btn btn-primary">„É≠„Ç∞„Ç§„É≥</button>
                </form>

                <form x-show="tab === 'signup'" @submit.prevent="signup()">
                    <div class="auth-error" x-show="signupError" x-text="signupError"></div>
                    <div class="form-group">
                        <label>ÂêçÂâç</label>
                        <input type="text" x-model="signupForm.name" required />
                    </div>
                    <div class="form-group">
                        <label>„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" x-model="signupForm.email" required />
                    </div>
                    <div class="form-group">
                        <label>„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" x-model="signupForm.password" required minlength="6" />
                    </div>
                    <button type="submit" class="btn btn-primary">„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó</button>
                </form>
            </div>
        </div>

        <!-- „É°„Ç§„É≥ÁîªÈù¢ -->
        <div id="main-screen" x-show="loggedIn">
            <header>
                <span x-text="userName + ' „Åß„É≠„Ç∞„Ç§„É≥‰∏≠'"></span>
                <button class="btn-logout" @click="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            </header>

            <div class="container">
                <div class="card">
                    <h2>Êú¨„ÇíËøΩÂä†</h2>
                    <form class="add-book-form" @submit.prevent="addBook()">
                        <div class="form-group">
                            <label>„Çø„Ç§„Éà„É´</label>
                            <input type="text" x-model="newBook.title" required />
                        </div>
                        <div class="form-group">
                            <label>ËëóËÄÖ</label>
                            <input type="text" x-model="newBook.author" required />
                        </div>
                        <div class="form-group">
                            <label>Âá∫ÁâàÂπ¥</label>
                            <input type="number" x-model="newBook.year" min="1000" max="9999" />
                        </div>
                        <button type="submit" class="btn btn-primary">ËøΩÂä†</button>
                    </form>
                </div>

                <div class="card">
                    <h2>Êú¨„ÅÆ‰∏ÄË¶ß</h2>
                    <form class="search-form" @submit.prevent="doSearch()">
                        <input type="text" x-model="searchQuery" placeholder="„Çø„Ç§„Éà„É´„Åæ„Åü„ÅØËëóËÄÖ„ÅßÊ§úÁ¥¢..." />
                        <button type="submit" class="btn btn-primary">Ê§úÁ¥¢</button>
                        <button type="button" @click="toggleFavFilter()" class="btn" :class="{ 'btn-primary': showFavoritesOnly }">
                            <span x-html="showFavoritesOnly ? '&#9829;' : '&#9825;'"></span> „ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Åø
                        </button>
                        <button type="button" @click="clearSearch()" class="btn">„ÇØ„É™„Ç¢</button>
                    </form>

                    <div x-show="loading" class="placeholder">Ë™≠„ÅøËæº„Åø‰∏≠...</div>

                    <table x-show="!loading && books.length > 0">
                        <thead>
                            <tr>
                                <th>„Çø„Ç§„Éà„É´</th>
                                <th>ËëóËÄÖ</th>
                                <th>Âá∫ÁâàÂπ¥</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="book in books" :key="book.id">
                                <tr>
                                    <td>
                                        <span x-show="editingId !== book.id" x-text="book.title"></span>
                                        <input x-show="editingId === book.id" class="edit-input" x-model="editForm.title" />
                                    </td>
                                    <td>
                                        <span x-show="editingId !== book.id" x-text="book.author"></span>
                                        <input x-show="editingId === book.id" class="edit-input" x-model="editForm.author" />
                                    </td>
                                    <td>
                                        <span x-show="editingId !== book.id" x-text="book.published_year || '‚Äî'"></span>
                                        <input x-show="editingId === book.id" class="edit-input" type="number" x-model="editForm.year" />
                                    </td>
                                    <td>
                                        <div x-show="editingId !== book.id" class="actions">
                                            <button class="btn-icon btn-fav" :class="{ active: favMap[book.id] }"
                                                @click="toggleFav(book.id)"
                                                x-html="favMap[book.id] ? '&#9829;' : '&#9825;'"
                                                title="„ÅäÊ∞ó„Å´ÂÖ•„Çä"></button>
                                            <button class="btn-icon btn-edit" @click="startEdit(book)" title="Á∑®ÈõÜ">&#9998;</button>
                                            <button class="btn-icon btn-delete" @click="deleteBook(book.id)" title="ÂâäÈô§">&#128465;</button>
                                        </div>
                                        <div x-show="editingId === book.id" class="actions">
                                            <button class="btn-icon btn-save" @click="saveEdit(book.id)" title="‰øùÂ≠ò">&#10003;</button>
                                            <button class="btn-icon btn-cancel" @click="cancelEdit()" title="„Ç≠„É£„É≥„Çª„É´">&#10007;</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="showPagination" class="pagination">
                        <button class="btn btn-page" :disabled="currentPage <= 1" @click="prevPage()">&laquo; Ââç„Å∏</button>
                        <span class="page-info" x-text="currentPage + ' / ' + totalPages"></span>
                        <button class="btn btn-page" :disabled="currentPage >= totalPages" @click="nextPage()">Ê¨°„Å∏ &raquo;</button>
                    </div>

                    <div x-show="!loading && books.length === 0 && totalCount === 0" class="placeholder">
                        Êú¨„Åå„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                    </div>
                </div>
            </div>

            <!-- Chat Toggle Button -->
            <button class="chat-toggle-btn" @click="toggleChat()">
                <span x-text="showChat ? 'üìö Books' : 'üí¨ Chat'"></span>
            </button>

            <!-- Chat Overlay -->
            <div class="chat-overlay" x-show="showChat">
                <div class="chat-container">
                    <!-- Left Sidebar: Room List -->
                    <div class="chat-sidebar">
                        <div class="chat-header">
                            <h3>„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†</h3>
                            <span class="connection-status" :class="{ connected: chatConnected }">
                                <span x-text="chatConnected ? 'üü¢ Êé•Á∂ö‰∏≠' : 'üî¥ ÂàáÊñ≠'"></span>
                            </span>
                        </div>

                        <!-- Create Room Form -->
                        <div class="create-room-form">
                            <input type="text" x-model="newRoomName" placeholder="„É´„Éº„É†Âêç" />
                            <input type="text" x-model="newRoomDescription" placeholder="Ë™¨ÊòéÔºà‰ªªÊÑèÔºâ" />
                            <button class="btn btn-primary btn-sm" @click="createRoom()">‰ΩúÊàê</button>
                        </div>

                        <!-- Room List -->
                        <div class="room-list">
                            <template x-for="room in chatRooms" :key="room.id">
                                <div class="room-item" :class="{ active: currentRoomId === room.id }">
                                    <div @click="room.is_member ? enterRoom(room.id) : null" :class="{ clickable: room.is_member }">
                                        <div class="room-name" x-text="room.name"></div>
                                        <div class="room-info">
                                            <span x-show="room.is_member" x-text="'ÂèÇÂä†‰∏≠'"></span>
                                            <span x-show="!room.is_member" x-text="'Êú™ÂèÇÂä†'"></span>
                                        </div>
                                    </div>
                                    <button x-show="!room.is_member" class="btn btn-sm btn-join" @click="joinRoom(room.id)">ÂèÇÂä†</button>
                                </div>
                            </template>
                            <div x-show="chatRooms.length === 0" class="placeholder-small">
                                „É´„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Messages -->
                    <div class="chat-main">
                        <div x-show="!currentRoomId" class="placeholder">
                            Â∑¶ÂÅ¥„Åã„Çâ„É´„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </div>

                        <div x-show="currentRoomId" class="chat-room">
                            <div class="chat-room-header">
                                <span x-text="chatRooms.find(r => r.id === currentRoomId)?.name || '„ÉÅ„É£„ÉÉ„Éà'"></span>
                            </div>

                            <div class="chat-messages">
                                <template x-for="msg in sortedMessages" :key="msg.id">
                                    <div class="chat-message">
                                        <div class="message-header">
                                            <span class="message-author" x-text="msg.user_name"></span>
                                            <span class="message-time" x-text="new Date(msg.created_at).toLocaleString()"></span>
                                        </div>
                                        <div class="message-body" x-text="msg.message"></div>
                                    </div>
                                </template>
                            </div>

                            <div class="typing-indicator" x-show="Object.keys(typingUsers).length > 0">
                                <span x-text="Object.values(typingUsers).join(', ') + ' „ÅåÂÖ•Âäõ‰∏≠...'"></span>
                            </div>

                            <div class="chat-input">
                                <input
                                    type="text"
                                    x-model="messageInput"
                                    @input="handleTyping()"
                                    @keyup.enter="sendChatMessage()"
                                    placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                                    :disabled="!chatConnected"
                                />
                                <button class="btn btn-primary" @click="sendChatMessage()" :disabled="!chatConnected || !messageInput.trim()">ÈÄÅ‰ø°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" :class="{ show: toastVisible, error: toastError }" x-text="toastMsg"></div>
    </body>
</html>
