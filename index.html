<!doctype html>
<html :lang="currentLang">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title x-text="t.app_title">Book Manager</title>
        <link rel="stylesheet" href="style.css" />
        <script defer src="i18n.js"></script>
        <script defer src="app.js"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
    </head>
    <body x-cloak x-data="bookApp()" x-init="init()">
        <!-- Ë™çË®ºÁîªÈù¢ -->
        <div id="auth-screen" x-show="!loggedIn">
            <div class="auth-card">
                <h1 x-text="t.app_title">Book Manager</h1>
                <div class="lang-switcher">
                    <button @click="switchLanguage('ja')" :class="{ active: currentLang === 'ja' }">Êó•Êú¨Ë™û</button>
                    <button @click="switchLanguage('en')" :class="{ active: currentLang === 'en' }">English</button>
                </div>
                <div class="tab-bar">
                    <button :class="{ active: tab === 'login' }" @click="tab = 'login'" x-text="t.login">„É≠„Ç∞„Ç§„É≥</button>
                    <button :class="{ active: tab === 'signup' }" @click="tab = 'signup'" x-text="t.signup">„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó</button>
                </div>

                <form x-show="tab === 'login'" @submit.prevent="login()">
                    <div class="auth-error" x-show="loginError" x-text="loginError"></div>
                    <div class="form-group">
                        <label x-text="t.email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" x-model="loginForm.email" required />
                    </div>
                    <div class="form-group">
                        <label x-text="t.password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" x-model="loginForm.password" required />
                    </div>
                    <button type="submit" class="btn btn-primary" x-text="t.login">„É≠„Ç∞„Ç§„É≥</button>
                </form>

                <form x-show="tab === 'signup'" @submit.prevent="signup()">
                    <div class="auth-error" x-show="signupError" x-text="signupError"></div>
                    <div class="form-group">
                        <label x-text="t.name">ÂêçÂâç</label>
                        <input type="text" x-model="signupForm.name" required />
                    </div>
                    <div class="form-group">
                        <label x-text="t.email">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" x-model="signupForm.email" required />
                    </div>
                    <div class="form-group">
                        <label x-text="t.password">„Éë„Çπ„ÉØ„Éº„Éâ</label>
                        <input type="password" x-model="signupForm.password" required minlength="6" />
                    </div>
                    <button type="submit" class="btn btn-primary" x-text="t.signup">„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó</button>
                </form>
            </div>
        </div>

        <!-- „É°„Ç§„É≥ÁîªÈù¢ -->
        <div id="main-screen" x-show="loggedIn">
            <header>
                <span x-text="userName + ' ' + t.logged_in_as"></span>
                <div class="header-actions">
                    <div class="lang-switcher">
                        <button @click="switchLanguage('ja')" :class="{ active: currentLang === 'ja' }">Êó•Êú¨Ë™û</button>
                        <button @click="switchLanguage('en')" :class="{ active: currentLang === 'en' }">English</button>
                    </div>
                    <button class="btn-logout" @click="logout()" x-text="t.logout">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </header>

            <div class="container">
                <div class="card">
                    <h2 x-text="t.add_book">Êú¨„ÇíËøΩÂä†</h2>
                    <form class="add-book-form" @submit.prevent="addBook()">
                        <div class="form-group">
                            <label x-text="t.title">„Çø„Ç§„Éà„É´</label>
                            <input type="text" x-model="newBook.title" required />
                        </div>
                        <div class="form-group">
                            <label x-text="t.author">ËëóËÄÖ</label>
                            <input type="text" x-model="newBook.author" required />
                        </div>
                        <div class="form-group">
                            <label x-text="t.published_year">Âá∫ÁâàÂπ¥</label>
                            <input type="number" x-model="newBook.year" min="1000" max="9999" />
                        </div>
                        <button type="submit" class="btn btn-primary" x-text="t.add">ËøΩÂä†</button>
                    </form>
                </div>

                <div class="card">
                    <h2 x-text="t.book_list">Êú¨„ÅÆ‰∏ÄË¶ß</h2>
                    <form class="search-form" @submit.prevent="doSearch()">
                        <input type="text" x-model="searchQuery" :placeholder="t.search_placeholder" />
                        <button type="submit" class="btn btn-primary" x-text="t.search">Ê§úÁ¥¢</button>
                        <button type="button" @click="toggleFavFilter()" class="btn" :class="{ 'btn-primary': showFavoritesOnly }">
                            <span x-html="showFavoritesOnly ? '&#9829;' : '&#9825;'"></span> <span x-text="t.favorites_only">„ÅäÊ∞ó„Å´ÂÖ•„Çä„ÅÆ„Åø</span>
                        </button>
                        <button type="button" @click="clearSearch()" class="btn" x-text="t.clear">„ÇØ„É™„Ç¢</button>
                    </form>

                    <div x-show="loading" class="placeholder" x-text="t.loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>

                    <table x-show="!loading && books.length > 0">
                        <thead>
                            <tr>
                                <th x-text="t.title">„Çø„Ç§„Éà„É´</th>
                                <th x-text="t.author">ËëóËÄÖ</th>
                                <th x-text="t.published_year">Âá∫ÁâàÂπ¥</th>
                                <th x-text="t.image">ÁîªÂÉè</th>
                                <th x-text="t.actions">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="book in books" :key="book.id">
                                <tr>
                                    <td>
                                        <span x-show="editingId !== book.id" x-text="book.title"></span>
                                        <input x-show="editingId === book.id" class="edit-input" x-model="editForm.title" />
                                    </td>
                                    <td>
                                        <span x-show="editingId !== book.id" x-text="book.author"></span>
                                        <input x-show="editingId === book.id" class="edit-input" x-model="editForm.author" />
                                    </td>
                                    <td>
                                        <span x-show="editingId !== book.id" x-text="book.published_year || '‚Äî'"></span>
                                        <input x-show="editingId === book.id" class="edit-input" type="number" x-model="editForm.year" />
                                    </td>
                                    <td>
                                        <div class="book-image-container">
                                            <template x-if="bookImages[book.id] && bookImages[book.id].length > 0">
                                                <div class="book-thumbnail-grid">
                                                    <template x-for="img in bookImages[book.id]" :key="img.id">
                                                        <div class="thumbnail-wrapper">
                                                            <img :src="getImageUrl(img.s3_key)" :alt="img.file_name" class="book-thumbnail" @click="viewImage(img)" />
                                                            <button class="btn-icon btn-delete-img" @click="deleteImage(img.id, book.id)" title="ÂâäÈô§">√ó</button>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                            <button class="btn-icon btn-upload" @click="openImageUpload(book.id)" title="ÁîªÂÉèËøΩÂä†">üì∑</button>
                                        </div>
                                    </td>
                                    <td>
                                        <div x-show="editingId !== book.id" class="actions">
                                            <button class="btn-icon btn-fav" :class="{ active: favMap[book.id] }"
                                                @click="toggleFav(book.id)"
                                                x-html="favMap[book.id] ? '&#9829;' : '&#9825;'"
                                                title="„ÅäÊ∞ó„Å´ÂÖ•„Çä"></button>
                                            <button class="btn-icon btn-edit" @click="startEdit(book)" title="Á∑®ÈõÜ">&#9998;</button>
                                            <button class="btn-icon btn-delete" @click="deleteBook(book.id)" title="ÂâäÈô§">&#128465;</button>
                                        </div>
                                        <div x-show="editingId === book.id" class="actions">
                                            <button class="btn-icon btn-save" @click="saveEdit(book.id)" title="‰øùÂ≠ò">&#10003;</button>
                                            <button class="btn-icon btn-cancel" @click="cancelEdit()" title="„Ç≠„É£„É≥„Çª„É´">&#10007;</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="showPagination" class="pagination">
                        <button class="btn btn-page" :disabled="currentPage <= 1" @click="prevPage()">&laquo; <span x-text="t.prev_page">Ââç„Å∏</span></button>
                        <span class="page-info" x-text="currentPage + ' / ' + totalPages"></span>
                        <button class="btn btn-page" :disabled="currentPage >= totalPages" @click="nextPage()"><span x-text="t.next_page">Ê¨°„Å∏</span> &raquo;</button>
                    </div>

                    <div x-show="!loading && books.length === 0 && totalCount === 0" class="placeholder" x-text="t.no_books">
                        Êú¨„Åå„Åæ„Å†ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ
                    </div>
                </div>
            </div>

            <!-- Chat Toggle Button -->
            <button class="chat-toggle-btn" @click="toggleChat()">
                <span x-text="showChat ? ('üìö ' + t.books) : ('üí¨ ' + t.chat)"></span>
            </button>

            <!-- Chat Overlay -->
            <div class="chat-overlay" x-show="showChat">
                <div class="chat-container">
                    <!-- Left Sidebar: Room List -->
                    <div class="chat-sidebar">
                        <div class="chat-header">
                            <h3 x-text="t.chat_rooms">„ÉÅ„É£„ÉÉ„Éà„É´„Éº„É†</h3>
                            <span class="connection-status" :class="{ connected: chatConnected }">
                                <span x-text="chatConnected ? ('üü¢ ' + t.connected) : ('üî¥ ' + t.disconnected)"></span>
                            </span>
                        </div>

                        <!-- Create Room Form -->
                        <div class="create-room-form">
                            <input type="text" x-model="newRoomName" :placeholder="t.room_name" />
                            <input type="text" x-model="newRoomDescription" :placeholder="t.description_optional" />
                            <button class="btn btn-primary btn-sm" @click="createRoom()" x-text="t.create">‰ΩúÊàê</button>
                        </div>

                        <!-- Room List -->
                        <div class="room-list">
                            <template x-for="room in chatRooms" :key="room.id">
                                <div class="room-item" :class="{ active: currentRoomId === room.id }">
                                    <div @click="room.is_member ? enterRoom(room.id) : null" :class="{ clickable: room.is_member }">
                                        <div class="room-name" x-text="room.name"></div>
                                        <div class="room-info">
                                            <span x-show="room.is_member" x-text="t.joined"></span>
                                            <span x-show="!room.is_member" x-text="t.not_joined"></span>
                                        </div>
                                    </div>
                                    <button x-show="!room.is_member" class="btn btn-sm btn-join" @click="joinRoom(room.id)" x-text="t.join">ÂèÇÂä†</button>
                                </div>
                            </template>
                            <div x-show="chatRooms.length === 0" class="placeholder-small" x-text="t.no_rooms">
                                „É´„Éº„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel: Messages -->
                    <div class="chat-main">
                        <div x-show="!currentRoomId" class="placeholder" x-text="t.select_room">
                            Â∑¶ÂÅ¥„Åã„Çâ„É´„Éº„É†„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </div>

                        <div x-show="currentRoomId" class="chat-room">
                            <div class="chat-room-header">
                                <span x-text="chatRooms.find(r => r.id === currentRoomId)?.name || t.chat"></span>
                            </div>

                            <div class="chat-messages">
                                <template x-for="msg in sortedMessages" :key="msg.id">
                                    <div class="chat-message">
                                        <div class="message-header">
                                            <span class="message-author" x-text="msg.user_name"></span>
                                            <span class="message-time" x-text="new Date(msg.created_at).toLocaleString()"></span>
                                        </div>
                                        <div class="message-body" x-text="msg.message"></div>
                                    </div>
                                </template>
                            </div>

                            <div class="typing-indicator" x-show="Object.keys(typingUsers).length > 0">
                                <span x-text="Object.values(typingUsers).join(', ') + ' ' + t.typing"></span>
                            </div>

                            <div class="chat-input">
                                <input
                                    type="text"
                                    x-model="messageInput"
                                    @input="handleTyping()"
                                    @keyup.enter="sendChatMessage()"
                                    :placeholder="t.message_placeholder"
                                    :disabled="!chatConnected"
                                />
                                <button class="btn btn-primary" @click="sendChatMessage()" :disabled="!chatConnected || !messageInput.trim()" x-text="t.send">ÈÄÅ‰ø°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Upload Modal -->
            <div class="modal-overlay" x-show="showImageUpload" @click.self="closeImageUpload()">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 x-text="t.upload_image">ÁîªÂÉè„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h3>
                        <button class="btn-close" @click="closeImageUpload()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <input type="file" @change="handleImageSelect($event)" accept="image/*" id="imageInput" />
                        <div x-show="selectedImageFile" class="image-preview">
                            <p x-text="selectedImageFile?.name"></p>
                            <p x-text="selectedImageFile ? (selectedImageFile.size / 1024).toFixed(2) + ' KB' : ''"></p>
                        </div>
                        <div x-show="uploadProgress > 0 && uploadProgress < 100" class="progress-bar">
                            <div class="progress-fill" :style="`width: ${uploadProgress}%`"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn" @click="closeImageUpload()" x-text="t.cancel">„Ç≠„É£„É≥„Çª„É´</button>
                        <button class="btn btn-primary" @click="uploadImage()" :disabled="!selectedImageFile || uploading" x-text="uploading ? t.uploading : t.upload">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</button>
                    </div>
                </div>
            </div>

            <!-- Image View Modal -->
            <div class="modal-overlay" x-show="showImageView" @click.self="closeImageView()">
                <div class="modal-content modal-large">
                    <div class="modal-header">
                        <h3 x-text="viewingImage?.file_name"></h3>
                        <button class="btn-close" @click="closeImageView()">√ó</button>
                    </div>
                    <div class="modal-body modal-body-image">
                        <img :src="viewingImage ? getImageUrl(viewingImage.s3_key) : ''" :alt="viewingImage?.file_name" class="full-image" />
                    </div>
                </div>
            </div>
        </div>

        <div class="toast" :class="{ show: toastVisible, error: toastError }" x-text="toastMsg"></div>
    </body>
</html>
